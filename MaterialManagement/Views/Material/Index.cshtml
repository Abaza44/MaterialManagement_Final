@{
    ViewData["Title"] = "إدارة المواد";
}

<h1>@ViewData["Title"]</h1>
<p><a asp-action="Create" class="btn btn-primary"><i class="bi bi-plus-circle"></i> إضافة مادة جديدة</a></p>

<div class="card shadow-sm mb-3">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-funnel"></i> فلاتر</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label for="isActiveFilter" class="form-label">عرض المواد</label>
                <select id="isActiveFilter" class="form-select">
                    <option value="true" selected>النشطة فقط</option>
                    <option value="false">غير النشطة فقط</option>
                    <option value="">عرض الكل</option>
                </select>
            </div>
        </div>
    </div>
</div>

<table id="materialsTable" class="table table-striped table-bordered" style="width:100%">
    <thead>
        <tr>
            <th data-name="Code">الكود</th>
            <th data-name="Name">الاسم</th>
            <th data-name="Quantity">الكمية بالمخزن</th>
            <th data-name="ReservedQuantity">المحجوزة</th>
            <th data-name="AvailableQuantity">المتاحة</th>
            <th>الإجراءات</th>
        </tr>
    </thead>
</table>

@section Scripts {
    <script>
        $(document).ready(function () {
            // تعريف الجدول لسهولة الاستخدام
            var materialsDataTable = $('#materialsTable').DataTable({
                "processing": true,       // لإظهار رسالة "جاري التحميل..."
                "serverSide": true,       // *** هذا هو أهم سطر، يفعل المعالجة من جانب الخادم ***
                "filter": true,           // لتفعيل صندوق البحث
                "ajax": {
                    "url": "/Material/LoadData",
                    "type": "POST",
                    "datatype": "json",
                    "data": function (d) {
                        
                        d.isActiveFilter = $('#isActiveFilter').val();
                    }
                },
                "columns": [
                    { "data": "code", "name": "Code", "autoWidth": true },
                    { "data": "name", "name": "Name", "autoWidth": true },
                    { "data": "quantity", "name": "Quantity", "autoWidth": true },
                    { "data": "reservedQuantity", "name": "ReservedQuantity", "autoWidth": true },
                    {
                        "data": "availableQuantity",
                        "name": "AvailableQuantity",
                        "autoWidth": true,
                        "render": function(data) {
                            return data < 0 ? `<span class="text-danger fw-bold">${data}</span>` : data;
                        }
                    },
                    {
                        "data": "id",
                        "render": function (data) {
                            // دالة لرسم أزرار الإجراءات ديناميكيًا
                            return `<a href='/Material/Edit/${data}' class='btn btn-sm btn-info'>تعديل</a> ` +
                                   `<a href='/Material/Details/${data}' class='btn btn-sm btn-secondary'>تفاصيل</a>`;
                        },
                        "orderable": false,
                        "searchable": false
                    }
                ],
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/Arabic.json"
                }
            });

            // عند تغيير قيمة الفلتر، قم بإعادة تحميل بيانات الجدول
            $('#isActiveFilter').on('change', function() {
                materialsDataTable.draw();
            });
        });
    </script>
}